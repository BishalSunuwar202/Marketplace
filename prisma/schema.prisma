generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ─── Enums ───────────────────────────────────────────────────────────────────

enum Role {
  USER
  SELLER
  ADMIN
  SUPER_ADMIN
}

enum AccountStatus {
  ACTIVE
  SUSPENDED
  BANNED
}

enum VerificationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ApplicationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ListingStatus {
  ACTIVE
  PAUSED
  SOLD
  DELETED
}

enum ListingCondition {
  NEW
  LIKE_NEW
  EXCELLENT
  GOOD
  FAIR
  POOR
}

enum OrderStatus {
  PENDING
  CONFIRMED
  SHIPPED
  DELIVERED
  CANCELLED
  REFUND_REQUESTED
  REFUNDED
}

// ─── NextAuth Required Models ────────────────────────────────────────────────

model Account {
  id                String  @id @default(uuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ─── Core User Model ─────────────────────────────────────────────────────────

model User {
  id                  String        @id @default(uuid())
  email               String        @unique
  passwordHash        String?
  name                String
  avatarUrl           String?
  phone               String?
  role                Role          @default(USER)
  accountStatus       AccountStatus @default(ACTIVE)
  suspensionReason    String?
  suspensionExpiresAt DateTime?
  emailVerified       DateTime?
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt

  accounts             Account[]
  sellerProfile        SellerProfile?
  sellerApplications   SellerApplication[]  @relation("Applicant")
  reviewedApplications SellerApplication[]  @relation("Reviewer")
  listings             Listing[]
  orders               Order[]              @relation("Buyer")
  sales                Order[]              @relation("Seller")
  reviewsWritten       Review[]
  reports              Report[]             @relation("Reporter")
  auditLogsPerformed   AuditLog[]
  tokenInvalidations   TokenInvalidation[]
  shippingAddresses    ShippingAddress[]

  @@index([email])
  @@index([role])
  @@index([accountStatus])
}

// ─── Seller Models ───────────────────────────────────────────────────────────

model SellerProfile {
  id                 String             @id @default(uuid())
  userId             String             @unique
  businessName       String
  description        String?            @db.Text
  logoUrl            String?
  returnPolicy       String?            @db.Text
  verificationStatus VerificationStatus @default(PENDING)
  verifiedAt         DateTime?
  verifiedBy         String?
  rating             Float              @default(0)
  totalSales         Int                @default(0)
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([verificationStatus])
}

model SellerApplication {
  id                  String            @id @default(uuid())
  userId              String
  status              ApplicationStatus @default(PENDING)
  businessName        String
  businessDescription String?           @db.Text
  applicationData     Json?
  reviewedBy          String?
  reviewedAt          DateTime?
  rejectionReason     String?
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  user     User  @relation("Applicant", fields: [userId], references: [id], onDelete: Cascade)
  reviewer User? @relation("Reviewer", fields: [reviewedBy], references: [id])

  @@index([userId])
  @@index([status])
}

// ─── Product Models ──────────────────────────────────────────────────────────

model Category {
  id          String   @id @default(uuid())
  name        String   @unique
  slug        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  listings Listing[]
}

model Brand {
  id        String   @id @default(uuid())
  name      String   @unique
  slug      String   @unique
  logoUrl   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  listings Listing[]
}

model Listing {
  id            String           @id @default(uuid())
  sellerId      String
  categoryId    String?
  brandId       String?
  title         String
  description   String           @db.Text
  model         String?
  specs         Json?
  condition     ListingCondition
  price         Decimal          @db.Decimal(10, 2)
  images        String[]
  status        ListingStatus    @default(ACTIVE)
  warrantyInfo  String?
  viewCount     Int              @default(0)
  favoriteCount Int              @default(0)
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  seller   User      @relation(fields: [sellerId], references: [id], onDelete: Cascade)
  category Category? @relation(fields: [categoryId], references: [id])
  brand    Brand?    @relation(fields: [brandId], references: [id])
  orders   Order[]
  reviews  Review[]
  reports  Report[]

  @@index([sellerId])
  @@index([status])
  @@index([categoryId])
  @@index([brandId])
  @@index([price])
  @@index([createdAt])
}

// ─── Order Models ────────────────────────────────────────────────────────────

model ShippingAddress {
  id        String   @id @default(uuid())
  userId    String
  fullName  String
  street    String
  city      String
  state     String
  zipCode   String
  country   String
  phone     String?
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders Order[]

  @@index([userId])
}

model Order {
  id                 String      @id @default(uuid())
  buyerId            String
  sellerId           String
  listingId          String
  shippingAddressId  String?
  status             OrderStatus @default(PENDING)
  totalAmount        Decimal     @db.Decimal(10, 2)
  trackingNumber     String?
  trackingUrl        String?
  notes              String?
  cancelledAt        DateTime?
  cancelledBy        String?
  cancellationReason String?
  refundReason       String?
  refundedAt         DateTime?
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt

  buyer           User             @relation("Buyer", fields: [buyerId], references: [id])
  seller          User             @relation("Seller", fields: [sellerId], references: [id])
  listing         Listing          @relation(fields: [listingId], references: [id])
  shippingAddress ShippingAddress? @relation(fields: [shippingAddressId], references: [id])

  @@index([buyerId])
  @@index([sellerId])
  @@index([status])
  @@index([createdAt])
}

// ─── Review Model ────────────────────────────────────────────────────────────

model Review {
  id        String   @id @default(uuid())
  userId    String
  listingId String
  rating    Int
  comment   String?  @db.Text
  isVisible Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  listing Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@unique([userId, listingId])
  @@index([listingId])
  @@index([userId])
}

// ─── Moderation Models ───────────────────────────────────────────────────────

model Report {
  id          String    @id @default(uuid())
  reporterId  String
  listingId   String?
  reason      String
  description String?   @db.Text
  status      String    @default("PENDING")
  resolvedBy  String?
  resolvedAt  DateTime?
  resolution  String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  reporter User     @relation("Reporter", fields: [reporterId], references: [id])
  listing  Listing? @relation(fields: [listingId], references: [id])

  @@index([reporterId])
  @@index([listingId])
  @@index([status])
}

model AuditLog {
  id         String   @id @default(uuid())
  actorId    String
  actorRole  Role
  action     String
  targetType String
  targetId   String
  metadata   Json?
  ipAddress  String?
  createdAt  DateTime @default(now())

  actor User @relation(fields: [actorId], references: [id])

  @@index([actorId])
  @@index([action])
  @@index([targetType, targetId])
  @@index([createdAt])
}

// ─── Token Invalidation (for mid-session role changes) ───────────────────────

model TokenInvalidation {
  id        String   @id @default(uuid())
  userId    String
  reason    String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}
